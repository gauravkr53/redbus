<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedBus - Book Ticket</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ðŸšŒ RedBus</h1>
            <div class="nav">
                <a href="/search">Search Buses</a>
                        <a href="/bookings/all-bookings">All Bookings</a>
                <form method="post" action="/logout" style="display: inline;">
                    <button type="submit" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Logout</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Book Your Ticket</h2>
            
            <!-- Booking Summary -->
            <div class="booking-summary">
                <h3>Trip Details</h3>
                <div class="summary-row">
                    <span><strong>Route:</strong></span>
                    <span th:text="${sourceCityName} + ' â†’ ' + ${destCityName}">Source â†’ Destination</span>
                </div>
                <div class="summary-row">
                    <span><strong>Date:</strong></span>
                    <span th:text="${date}">Date</span>
                </div>
                <div class="summary-row">
                    <span><strong>Time:</strong></span>
                    <span th:text="${sourceTime} + ' - ' + ${destTime}">Time</span>
                </div>
                <div class="summary-row">
                    <span><strong>Operator:</strong></span>
                    <span th:text="${busId}">Bus Operator</span>
                </div>
                <div class="summary-row">
                    <span><strong>Available Seats:</strong></span>
                    <span th:text="${availableSeats}">Seats</span>
                </div>
            </div>

            <!-- Booking Form -->
            <form method="post" action="/book">
                <input type="hidden" name="tripId" th:value="${tripId}">
                <input type="hidden" name="sourceCityId" th:value="${sourceCityId}">
                <input type="hidden" name="destCityId" th:value="${destCityId}">
                
                <div class="form-group">
                    <label for="seats">Number of Seats</label>
                    <input type="number" id="seats" name="seats" class="form-control" 
                           min="1" max="10" value="1" required>
                    <small>Maximum 10 seats per booking</small>
                </div>
                
                <!-- Price Calculation -->
                <div class="booking-summary">
                    <h3>Price Breakdown</h3>
                    <div class="summary-row">
                        <span>Price per seat:</span>
                        <span>â‚¹<span th:text="${#numbers.formatDecimal(pricePaise / 100, 1, 2)}" id="basePrice">0.00</span></span>
                    </div>
                    <div class="summary-row">
                        <span>Number of seats:</span>
                        <span id="seatCount">1</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total Amount:</span>
                        <span>â‚¹<span id="totalPrice" th:text="${#numbers.formatDecimal(pricePaise / 100, 1, 2)}" data-base-price="${pricePaise}">0.00</span></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <a href="/search" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none;">Cancel</a>
                    <button type="submit" class="btn" style="flex: 2;">Proceed to Payment</button>
                </div>
            </form>
        </div>
    </div>

    <script th:src="@{/js/app.js}"></script>
    <script>
        // Get base price from the template - use inline script to ensure proper value passing
        let basePricePaise = [[${pricePaise}]];
        console.log('Base price in paise:', basePricePaise);
        console.log('Type of basePricePaise:', typeof basePricePaise);

        // Fallback: get from data attribute if Thymeleaf value is not available
        if (!basePricePaise || basePricePaise === 0) {
            const totalPriceElement = document.getElementById('totalPrice');
            if (totalPriceElement && totalPriceElement.dataset.basePrice) {
                basePricePaise = parseInt(totalPriceElement.dataset.basePrice);
            }
        }
        
        // Final fallback
        if (!basePricePaise || basePricePaise === 0) {
            basePricePaise = 122500;
        }
        
        console.log('Base price in paise:', basePricePaise);
        console.log('Type of basePricePaise:', typeof basePricePaise);
        
        function updateTotalPrice() {
            console.log('updateTotalPrice called');
            const seatCount = parseInt(document.getElementById('seats').value) || 1;
            console.log('Seat count:', seatCount);
            
            const seatCountElement = document.getElementById('seatCount');
            const totalPriceElement = document.getElementById('totalPrice');
            
            console.log('Elements found:', {
                seatCountElement: !!seatCountElement,
                totalPriceElement: !!totalPriceElement,
                basePricePaise: basePricePaise
            });
            
            if (seatCountElement) {
                seatCountElement.textContent = seatCount;
                console.log('Updated seat count display to:', seatCount);
            }
            
            if (totalPriceElement && basePricePaise) {
                // Calculate total price
                const totalPricePaise = basePricePaise * seatCount;
                const totalPriceRupees = (totalPricePaise / 100.0).toFixed(2);
                console.log('Calculating:', basePricePaise, '*', seatCount, '=', totalPricePaise, 'paise =', totalPriceRupees, 'rupees');
                
                totalPriceElement.textContent = totalPriceRupees;
                console.log('Updated total price element textContent to:', totalPriceRupees);
                console.log('Element actual textContent:', totalPriceElement.textContent);
            } else {
                console.error('Missing elements or basePricePaise:', {
                    totalPriceElement: !!totalPriceElement,
                    basePricePaise: basePricePaise
                });
            }
        }
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing price calculation');
            
            // Re-initialize basePricePaise in case Thymeleaf value wasn't available earlier
            if (!basePricePaise || basePricePaise === 0) {
                const totalPriceElement = document.getElementById('totalPrice');
                if (totalPriceElement && totalPriceElement.dataset.basePrice) {
                    basePricePaise = parseInt(totalPriceElement.dataset.basePrice);
                    console.log('Re-initialized basePricePaise from data attribute:', basePricePaise);
                }
            }
            
            setTimeout(updateTotalPrice, 100); // Small delay to ensure everything is ready
        });
        
        // Update seat count display and total price when input changes
        document.addEventListener('DOMContentLoaded', function() {
            const seatsInput = document.getElementById('seats');
            if (seatsInput) {
                seatsInput.addEventListener('input', function() {
                    console.log('Seats input changed to:', this.value);
                    updateTotalPrice();
                });
                console.log('Added event listener to seats input');
            } else {
                console.error('Could not find seats input element');
            }
        });
    </script>
</body>
</html>
